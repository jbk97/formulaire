<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposer un Ã‰vÃ©nement - Coucou les Goudous</title>
    <style>
        /* CSS PERSONNALISÃ‰ inspirÃ© de style (8).css avec teintes violettes */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f6f7fb; /* Light background */
            color: #333;
            line-height: 1.6;
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box; /* Ensures padding doesn't affect total width/height */
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 20px auto;
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); /* Softer shadow */
            box-sizing: border-box;
        }

        h1, h2 {
            color: #6f42c1; /* Deep violet for main headings */
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700; /* Bolder for headings */
        }

        p {
            text-align: center;
            color: #6a737d; /* Softer text color */
            margin-bottom: 20px;
        }

        .section-content {
            padding: 20px 0;
        }

        /* Section display management */
        .section {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-out; /* Fade-in effect */
        }

        .section.active {
            display: block; /* Visible when active */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Intro Section Specifics */
        .intro-text {
            font-size: 1.1em;
            text-align: justify;
            margin-bottom: 25px;
            color: #495057;
        }
        .intro-text strong {
            color: #2e3b4e;
        }
        .intro-text ul {
            list-style: none;
            padding-left: 0;
            margin-top: 15px;
        }
        .intro-text ul li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 25px;
            color: #5a6268;
        }
        .intro-text ul li:before {
            content: 'âœ…'; /* Checkmark for lists */
            position: absolute;
            left: 0;
            color: #28a745; /* Green check */
            font-size: 0.9em;
        }
        .intro-text ul.attention-list li:before {
            content: 'ðŸ“Œ'; /* Pin for attention list */
            color: #ffc107; /* Orange pin */
        }
        .intro-text ul.how-it-works li:before {
            content: 'ðŸ“…'; /* Calendar for how it works */
            color: #007bff; /* Blue calendar */
        }
        .intro-text .highlight {
            color: #8a2be2; /* Violet highlight for important text */
            font-weight: bold;
        }
        .social-link {
            display: block;
            text-align: center;
            margin-top: 25px;
            font-size: 1.1em;
            color: #8a2be2;
            text-decoration: none;
            font-weight: bold;
        }
        .social-link:hover {
            text-decoration: underline;
        }


        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #495057;
            font-size: 1.05em;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="url"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dcdfe6;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="url"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            border-color: #8a2be2; /* Violet focus */
            box-shadow: 0 0 0 0.2rem rgba(138, 43, 226, 0.25);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        small {
            display: block;
            color: #909399;
            margin-top: 6px;
            font-size: 0.88em;
        }

        .required {
            color: #f56c6c;
            font-size: 0.9em;
            margin-left: 4px;
        }

        /* Validation feedback */
        .form-group.is-invalid input:not([type="checkbox"]),
        .form-group.is-invalid textarea {
            border-color: #f56c6c;
        }

        .form-group.is-invalid .error-message {
            color: #f56c6c;
            font-size: 0.85em;
            margin-top: 5px;
            display: block;
        }

        /* General Button Styles */
        .main-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background-color: #8a2be2; /* Violet pour les boutons principaux */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.15em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 35px;
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3);
            text-decoration: none; /* For link-buttons */
            text-align: center; /* For link-buttons */
        }

        .main-button:hover {
            background-color: #a366e7; /* Violet plus clair au survol */
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(138, 43, 226, 0.4);
        }

        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(138, 43, 226, 0.5);
        }

        .status-message {
            text-align: center;
            margin-top: 25px;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
        }
        .status-message[style*="color: rgb(103, 194, 58)"] { /* Green for success rgb(103, 194, 58) */
            color: #67c23a;
        }
        .status-message[style*="color: rgb(245, 108, 108)"] { /* Red for error rgb(245, 108, 108) */
            color: #f56c6c;
        }
        .status-message[style*="color: rgb(138, 43, 226)"] { /* Violet for sending, based on primary button */
            color: #8a2be2;
        }

        /* Styles for Checkbox Groups (standard checkboxes with improved look) */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            padding: 5px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-size: 1em;
            color: #606266;
            padding: 5px 0;
        }

        .checkbox-item input[type="checkbox"] {
            -webkit-appearance: checkbox;
            -moz-appearance: checkbox;
            appearance: checkbox;
            width: 18px;
            height: 18px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            margin-top: 0;
            flex-shrink: 0;
            accent-color: #8a2be2; /* Violet accent for native checkboxes */
        }


        /* Autocomplete styles */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #dcdfe6;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 0 0 8px 8px;
        }

        .autocomplete-items div {
            padding: 12px 15px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #ebeef5;
            transition: background-color 0.2s ease;
        }

        .autocomplete-items div:hover {
            background-color: #f0f2f5;
        }

        .autocomplete-active {
            background-color: #f2e6fa !important; /* Lighter violet for active autocomplete item */
            color: #6f42c1; /* Deeper violet text for active */
        }

        /* Confirmation Section */
        .confirmation-message {
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 25px;
            color: #495057;
        }
        .confirmation-message strong {
            color: #6f42c1;
        }
        .support-message {
            font-size: 1em;
            text-align: center;
            margin-top: 30px;
            color: #6a737d;
        }
        .support-message strong {
            color: #2e3b4e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="intro-section" class="section active">
            <h1>Proposer un Ã©vÃ©nement</h1>
            <div class="intro-text">
                <p>Propose ton Ã©vÃ©nement pour L'Agenda Lesbo-Queer de Coucou les Goudous ! ðŸŒˆ</p>
                <p>Tu veux faire connaÃ®tre un Ã©vÃ©nement lesbo-queer ?<br>
                Tu veux qu'il apparaisse dans notre agenda en ligne ?<br>
                Remplis ce formulaire et on sâ€™occupe du reste ! âœ¨</p>

                <p class="highlight">âœ… Quels types dâ€™Ã©vÃ©nements ?</p>
                <ul>
                    <li>SoirÃ©es, shows, confÃ©rences, rassemblements, rencontres littÃ©raires, projections, expositions, cercles de parole, festivalsâ€¦</li>
                </ul>
                <p>Tous les formats sont acceptÃ©s !</p>

                <p class="highlight attention-list">ðŸ“Œ Attention !</p>
                <ul class="attention-list">
                    <li>Un Ã©vÃ©nement peut Ãªtre refusÃ© sâ€™il est :</li>
                    <li>Hors sujet</li>
                    <li>Incomplet</li>
                    <li>Contradictoire avec les valeurs queers</li>
                    <li>Discriminatoire</li>
                    <li>Promotionnel sans lien avec la communautÃ©</li>
                    <li>DÃ©jÃ  soumis (doublon)</li>
                </ul>

                <p class="highlight how-it-works">ðŸ“… Comment Ã§a marche ?</p>
                <ul class="how-it-works">
                    <li>Remplis les infos ci-dessous</li>
                    <li>On vÃ©rifie et on valide</li>
                    <li>Ton Ã©vÃ©nement est ajoutÃ© Ã  notre agenda, visible par toute notre commu !</li>
                </ul>
                <p class="highlight">ðŸ’¡ C'est gratuit et ouvert Ã  tousÂ·tes !</p>
                <p>Merci de contribuer Ã  visibiliser les initiatives les.bi.ennes et queers et Ã  rendre notre agenda encore plus complet ! ðŸ’œðŸ”¥</p>
                <a href="https://www.instagram.com/coucoulesgoudous" target="_blank" class="social-link">ðŸ“· Instagram : @coucoulesgoudous</a>
            </div>
            <button type="button" id="startFormButton" class="main-button">Soumettre un Ã©vÃ©nement</button>
        </div>

        <div id="form-section" class="section">
            <h1>Proposer un Ã‰vÃ©nement</h1>
            <p>Veuillez remplir les informations ci-dessous pour soumettre votre Ã©vÃ©nement.</p>

            <form id="eventSubmissionForm" novalidate>
                <div class="form-group">
                    <label for="eventName">Nom de l'Ã©vÃ©nement <span class="required">*</span></label>
                    <input type="text" id="eventName" name="NomEvenement" required placeholder="Exemples : 'Drag Kings en feu', 'ApÃ©ro LittÃ©raire Lesbien', 'Cercle de parole Trans'">
                    <small>Pas besoin de tout expliquer ici, tu pourras le faire dans la description.</small>
                </div>

                <div class="form-group">
                    <label for="eventStartDate">Date de l'Ã©vÃ©nement <span class="required">*</span></label>
                    <input type="date" id="eventStartDate" name="DateDebut" required>
                </div>

                <div class="form-group">
                    <label for="eventEndDate">Date de fin de l'Ã©vÃ©nement : <small>(Que si l'Ã©vÃ©nement dure plusieurs jours !)</small></label>
                    <input type="date" id="eventEndDate" name="DateFin">
                </div>

                <div class="form-group">
                    <label for="eventStartTime">Heure de dÃ©but</label>
                    <input type="time" id="eventStartTime" name="HeureDebut">
                </div>

                <div class="form-group">
                    <label for="eventEndTime">Heure de fin</label>
                    <input type="time" id="eventEndTime" name="HeureFin">
                </div>

                <div class="form-group autocomplete-container">
                    <label for="eventAddressAutocomplete">Adresse de l'Ã©vÃ©nement <span class="required">*</span></label>
                    <small>Commencez Ã  taper une adresse franÃ§aise pour l'autocomplÃ©tion.</small>
                    <input type="text" id="eventAddressAutocomplete" name="AdresseAutocomplete" placeholder="Rechercher une adresse..." required>
                    <div id="autocomplete-results" class="autocomplete-items"></div>
                    <input type="hidden" id="eventAddress" name="Adresse">
                    <input type="hidden" id="eventCity" name="Ville">
                </div>

                <div class="form-group">
                    <label for="eventLocationName">Lieu (Nom de l'endroit)</label>
                    <input type="text" id="eventLocationName" name="DonneesEvenementsLieu" placeholder="Nom de la salle, du bar, etc.">
                </div>

                <div class="form-group">
                    <label>Type d'Ã©vÃ©nement <span class="required">*</span></label>
                    <small>Choisissez les catÃ©gories qui dÃ©crivent vraiment l'Ã©vÃ©nement. Ã‡a aide Ã  bien le classer dans l'agenda.</small>
                    <div class="checkbox-group" id="eventTypeCheckboxes">
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_apero" name="TypeEvenement[]" value="ApÃ©ro & Groupe de parole">
                            <label for="tag_apero">ApÃ©ro & Groupe de parole</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_cabaret" name="TypeEvenement[]" value="Cabaret & Show">
                            <label for="tag_cabaret">Cabaret & Show</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_cirque" name="TypeEvenement[]" value="Cirque">
                            <label for="tag_cirque">Cirque</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_concert" name="TypeEvenement[]" value="Concert">
                            <label for="tag_concert">Concert</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_conf" name="TypeEvenement[]" value="ConfÃ©rence & Table ronde">
                            <label for="tag_conf">ConfÃ©rence & Table ronde</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_drag" name="TypeEvenement[]" value="Drag King">
                            <label for="tag_drag">Drag King</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_expo" name="TypeEvenement[]" value="Exposition">
                            <label for="tag_expo">Exposition</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_festival" name="TypeEvenement[]" value="Festival">
                            <label for="tag_festival">Festival</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_formation" name="TypeEvenement[]" value="Formation & Atelier">
                            <label for="tag_formation">Formation & Atelier</label>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_karaoke" name="TypeEvenement[]" value="KaraokÃ© & Blindtest">
                            <label for="tag_karaoke">KaraokÃ© & Blindtest</label>
                        </div>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_litterature" name="TypeEvenement[]" value="LittÃ©rature">
                            <label for="tag_litterature">LittÃ©rature</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_projection" name="TypeEvenement[]" value="Projection">
                            <label for="tag_projection">Projection</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_rassemblement" name="TypeEvenement[]" value="Rassemblement & Marche">
                            <label for="tag_rassemblement">Rassemblement & Marche</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_soiree_dj" name="TypeEvenement[]" value="SoirÃ©e & DJ Set">
                            <label for="tag_soiree_dj">SoirÃ©e & DJ Set</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_soiree_techno" name="TypeEvenement[]" value="Soiree Techno">
                            <label for="tag_soiree_techno">Soiree Techno</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_standup" name="TypeEvenement[]" value="Stand up">
                            <label for="tag_standup">Stand up</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_sport" name="TypeEvenement[]" value="Sport">
                            <label for="tag_sport">Sport</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tag_theatre" name="TypeEvenement[]" value="ThÃ©Ã¢tre">
                            <label for="tag_theatre">ThÃ©Ã¢tre</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Public majoritaire ciblÃ© <span class="required">*</span></label>
                    <div class="checkbox-group" id="targetAudienceCheckboxes">
                        <div class="checkbox-item">
                            <input type="checkbox" id="audience_lesbien" name="PublicCible[]" value="Lesbien">
                            <label for="audience_lesbien">Lesbien</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="audience_bipan" name="PublicCible[]" value="Bipan">
                            <label for="audience_bipan">Bipan</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="audience_trans" name="PublicCible[]" value="Trans">
                            <label for="audience_trans">Trans</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="audience_lesbientrans" name="PublicCible[]" value="LesBien&Trans">
                            <label for="audience_lesbientrans">LesBien&Trans</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="audience_lgbtqia" name="PublicCible[]" value="LGBTQIA+">
                            <label for="audience_lgbtqia">LGBTQIA+</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="audience_lgbtfriendly" name="PublicCible[]" value="LGBT+ friendly">
                            <label for="audience_lgbtfriendly">LGBT+ friendly</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="eventDescription">Description de l'Ã©vÃ©nement <span class="required">*</span></label>
                    <textarea id="eventDescription" name="Description" rows="6" required placeholder="Raconte ici ce qu'il va se passer."></textarea>
                </div>

                <div class="form-group">
                    <label for="eventPhotoUrl">Visuel de l'Ã©vÃ©nement :</label>
                    <small>Copiez/Collez ici l'URL d'une image. Uploader une image vous donnera une belle visibilitÃ© !</small>
                    <input type="url" id="eventPhotoUrl" name="PhotoUrl" placeholder="Ex: https://votresite.com/image.jpg">
                </div>

                <div class="form-group">
                    <label>Liens vers l'Ã©vÃ©nement :</label>
                    <small>Un lien de rÃ©servation ou vers un post Instagram est fortement recommandÃ©. Sinon, un autre lien d'accÃ¨s Ã  l'Ã©vÃ©nement peut Ãªtre fourni pour amÃ©liorer la visibilitÃ©.</small>
                    <input type="url" id="instagramLink" name="LienInstagram" placeholder="Lien vers le post Instagram">
                    <input type="url" id="facebookLink" name="LienFacebook" placeholder="Lien vers l'event Facebook">
                    <input type="url" id="shotgunLink" name="LienShotgun" placeholder="Lien vers la rÃ©servation Shotgun">
                    <input type="url" id="diceLink" name="LienDice" placeholder="Lien vers la rÃ©servation Dice">
                    <input type="url" id="otherReservationLink" name="LienAutreReservation" placeholder="Lien vers un autre systÃ¨me de rÃ©servation">
                    <input type="url" id="eventPageLink" name="SiteURL" placeholder="Lien Principal de l'Ã©vÃ©nement (Site web, billetterie, ou autre page officielle)">
                </div>

                <div class="form-group">
                    <label for="eventOrganizer">Organisateur</label>
                    <input type="text" id="eventOrganizer" name="Organisateur">
                </div>

                <div class="form-group">
                    <label for="eventAdditionalInfo">Autres notes :</label>
                    <textarea id="eventAdditionalInfo" name="InfoAdd" rows="3" placeholder="Informations supplÃ©mentaires, remarques..."></textarea>
                </div>

                <div class="form-group">
                    <label for="eventPrice">Tarif</label>
                    <input type="text" id="eventPrice" name="Tarif" placeholder="Ex: Gratuit, 5â‚¬, EntrÃ©e libre, de 10â‚¬ Ã  15â‚¬">
                </div>

                <div class="form-group">
                    <label for="eventAccessibility">AccessibilitÃ© (PMR) :</label>
                    <textarea id="eventAccessibility" name="AccessibilitePMR" rows="3" placeholder="Informations sur l'accÃ¨s pour les personnes Ã  mobilitÃ© rÃ©duite."></textarea>
                </div>

                <h2>Vos coordonnÃ©es (Ne seront pas affichÃ©es publiquement)</h2>

                <div class="form-group">
                    <label for="submitterName">Nom <span class="required">*</span></label>
                    <small>PrÃ©nom & prÃ©nom ou bien nom du collectif. Cela n'apparaÃ®tra pas en ligne.</small>
                    <input type="text" id="submitterName" name="ViaNom" required>
                </div>

                <div class="form-group">
                    <label for="submitterEmail">Email <span class="required">*</span></label>
                    <small>Pour te prÃ©venir de la validation de ton Ã©vÃ©nement. Cela n'apparaÃ®tra pas en ligne.</small>
                    <input type="email" id="submitterEmail" name="ViaMail" required>
                </div>

                <button type="submit" id="submitButton" class="main-button">Envoyer l'Ã©vÃ©nement</button>
                <p id="statusMessage" class="status-message"></p>
            </form>
        </div>

        <div id="confirmation-section" class="section">
            <h1 class="confirmation-message">Merci <span id="confirmation-name"></span> !</h1>
            <p class="confirmation-message">Votre proposition va Ãªtre examinÃ©e par nos Ã©quipes.</p>
            <p class="support-message">
                Chaque euro compte pour pÃ©renniser l'Agenda ! <br>
                Merci de contribuer Ã  visibiliser les initiatives les.bi.ennes et queers et Ã  rendre notre agenda encore plus complet ! ðŸ’œðŸ”¥
            </p>
            <a href="https://www.coucoulesgoudous.com/soutien" target="_blank" class="main-button">Je soutiens</a>
        </div>
    </div>

    <script>
        /* JAVASCRIPT AMÃ‰LIORÃ‰ */
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('eventSubmissionForm');
            const statusMessage = document.getElementById('statusMessage');
            const localStorageKey = 'eventFormDraft'; // ClÃ© pour localStorage

            const introSection = document.getElementById('intro-section');
            const formSection = document.getElementById('form-section');
            const confirmationSection = document.getElementById('confirmation-section');
            const startFormButton = document.getElementById('startFormButton');
            const confirmationNameSpan = document.getElementById('confirmation-name');

            const addressAutocompleteInput = document.getElementById('eventAddressAutocomplete');
            const autocompleteResultsDiv = document.getElementById('autocomplete-results');
            const eventAddressInput = document.getElementById('eventAddress');
            const eventCityInput = document.getElementById('eventCity');

            let currentTimeout = null;
            let currentActiveItem = -1; // For keyboard navigation in autocomplete

            // URL de votre application web Google Apps Script
            const googleAppsScriptWebAppUrl = 'https://script.google.com/macros/s/AKfycbyMbLq_PoKQa9k9CH53bQqkjS6xm0Hjj42psK-RCWvNnQrxmLma3itZSeYvldlrI17QxQ/exec'; 

            // --- Fonction pour afficher les sections ---
            const showSection = (sectionId) => {
                const sections = document.querySelectorAll('.section');
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of the new section
            };

            // --- Persistance des donnÃ©es (LocalStorage) ---
            const saveFormToLocalStorage = () => {
                const data = {};
                form.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.type === 'checkbox') {
                        if (field.name.endsWith('[]')) {
                            const cleanName = field.name.slice(0, -2);
                            if (!data[cleanName]) {
                                data[cleanName] = [];
                            }
                            if (field.checked) {
                                data[cleanName].push(field.value);
                            }
                        } else if (field.name) {
                             data[field.name] = field.checked;
                        }
                    } else if (field.type !== 'submit' && field.name) {
                        data[field.name] = field.value;
                    }
                });
                localStorage.setItem(localStorageKey, JSON.stringify(data));
            };

            const loadFormFromLocalStorage = () => {
                const savedData = localStorage.getItem(localStorageKey);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    for (const key in data) {
                        const fields = form.querySelectorAll(`[name="${key}"]`);
                        if (fields.length > 0) {
                            if (fields.length === 1 && fields[0].type !== 'checkbox') {
                                fields[0].value = data[key];
                            } else {
                                fields.forEach(field => {
                                    if (field.type === 'checkbox') {
                                        if (Array.isArray(data[key])) {
                                            field.checked = data[key].includes(field.value);
                                        } else {
                                            field.checked = data[key];
                                        }
                                    }
                                });
                            }
                        } else if (key === 'TypeEvenement' || key === 'PublicCible') {
                            if (Array.isArray(data[key])) {
                                data[key].forEach(val => {
                                    const checkbox = form.querySelector(`[name="${key}[]"][value="${val}"]`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                    }
                                });
                            }
                        }
                    }
                }
            };

            // Ã‰coute les changements pour sauvegarder
            form.addEventListener('input', saveFormToLocalStorage);
            form.addEventListener('change', saveFormToLocalStorage);


            // --- AutocomplÃ©tion de l'adresse (API Etalab) ---
            const fetchAddressSuggestions = async (query) => {
                if (query.length < 3) {
                    autocompleteResultsDiv.innerHTML = '';
                    currentActiveItem = -1;
                    return;
                }

                if (currentTimeout) clearTimeout(currentTimeout);

                currentTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                        const data = await response.json();
                        displayAddressSuggestions(data.features);
                    } catch (error) {
                        console.error("Erreur lors de la rÃ©cupÃ©ration des adresses :", error);
                        autocompleteResultsDiv.innerHTML = '<div style="color: red;">Erreur de chargement des adresses.</div>';
                    }
                }, 300);
            };

            const displayAddressSuggestions = (features) => {
                autocompleteResultsDiv.innerHTML = '';
                currentActiveItem = -1;

                if (features.length === 0) {
                    autocompleteResultsDiv.innerHTML = '<div>Aucun rÃ©sultat trouvÃ©.</div>';
                    return;
                }

                features.forEach((feature, index) => {
                    const div = document.createElement('div');
                    div.textContent = feature.properties.label;
                    div.addEventListener('click', () => {
                        selectAddress(feature);
                    });
                    div.setAttribute('data-index', index);
                    autocompleteResultsDiv.appendChild(div);
                });
            };

            const selectAddress = (feature) => {
                addressAutocompleteInput.value = feature.properties.label;
                eventAddressInput.value = feature.properties.name || feature.properties.label.split(',')[0].trim();
                eventCityInput.value = feature.properties.city;
                autocompleteResultsDiv.innerHTML = '';
                saveFormToLocalStorage();
            };

            addressAutocompleteInput.addEventListener('input', (e) => {
                fetchAddressSuggestions(e.target.value);
            });

            addressAutocompleteInput.addEventListener('keydown', (e) => {
                const items = autocompleteResultsDiv.querySelectorAll('div');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentActiveItem = (currentActiveItem + 1) % items.length;
                    setActiveItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentActiveItem = (currentActiveItem - 1 + items.length) % items.length;
                    setActiveItem(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentActiveItem > -1) {
                        items[currentActiveItem].click();
                    }
                }
            });

            document.addEventListener('click', (e) => {
                if (!addressAutocompleteInput.contains(e.target) && !autocompleteResultsDiv.contains(e.target)) {
                    autocompleteResultsDiv.innerHTML = '';
                    currentActiveItem = -1;
                }
            });

            // --- Validation du Formulaire ---
            const validateForm = () => {
                let isValid = true;
                const formGroups = form.querySelectorAll('.form-group');

                formGroups.forEach(formGroup => {
                    formGroup.classList.remove('is-invalid');
                    const errorMessage = formGroup.querySelector('.error-message');
                    if (errorMessage) errorMessage.remove();

                    const inputs = formGroup.querySelectorAll('input:not([type="hidden"]), textarea');
                    let groupHasError = false;

                    if (formGroup.querySelector('.checkbox-group')) {
                        const groupRequired = (formGroup.querySelector('label span.required') !== null);

                        if (groupRequired) {
                            let oneChecked = false;
                            const checkboxes = formGroup.querySelectorAll('input[type="checkbox"]');
                            checkboxes.forEach(chk => {
                                if (chk.checked) oneChecked = true;
                            });

                            if (!oneChecked) {
                                formGroup.classList.add('is-invalid');
                                let errMessage = document.createElement('div');
                                errMessage.classList.add('error-message');
                                errMessage.textContent = 'Veuillez sÃ©lectionner au moins une option.';
                                formGroup.appendChild(errMessage);
                                groupHasError = true;
                                isValid = false;
                            }
                        }
                    }

                    inputs.forEach(field => {
                        if (groupHasError) return;

                        if (field.hasAttribute('required') && field.value.trim() === '') {
                            formGroup.classList.add('is-invalid');
                            let errMessage = document.createElement('div');
                            errMessage.classList.add('error-message');
                            errMessage.textContent = 'Ce champ est requis.';
                            formGroup.appendChild(errMessage);
                            groupHasError = true;
                            isValid = false;
                        } else if (field.type === 'email' && !field.validity.valid) {
                            formGroup.classList.add('is-invalid');
                            let errMessage = document.createElement('div');
                            errMessage.classList.add('error-message');
                            errMessage.textContent = 'Veuillez entrer une adresse email valide.';
                            formGroup.appendChild(errMessage);
                            groupHasError = true;
                            isValid = false;
                        }
                    });
                });
                return isValid;
            };

            form.addEventListener('input', (e) => {
                const field = e.target;
                const formGroup = field.closest('.form-group');
                if (formGroup) {
                    if (field.type === 'checkbox' && field.name.endsWith('[]')) {
                        const groupRequired = (formGroup.querySelector('label span.required') !== null);
                        if (groupRequired) {
                            const checkboxesInGroup = formGroup.querySelectorAll('input[type="checkbox"]:checked');
                            if (checkboxesInGroup.length > 0) {
                                formGroup.classList.remove('is-invalid');
                                const errorMessage = formGroup.querySelector('.error-message');
                                if (errorMessage) errorMessage.remove();
                            }
                        }
                    } else {
                        if (formGroup.classList.contains('is-invalid')) {
                            if (field.checkValidity()) {
                                formGroup.classList.remove('is-invalid');
                                const errorMessage = formGroup.querySelector('.error-message');
                                if (errorMessage) errorMessage.remove();
                            }
                        }
                    }
                }
            });

            // --- Gestion de la soumission du Formulaire ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                statusMessage.textContent = '';
                statusMessage.style.color = '#333';

                if (!validateForm()) {
                    statusMessage.textContent = 'Veuillez corriger les erreurs dans le formulaire.';
                    statusMessage.style.color = '#f56c6c';
                    const firstInvalid = form.querySelector('.is-invalid input, .is-invalid textarea, .is-invalid .checkbox-group');
                    if(firstInvalid) {
                        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }

                statusMessage.textContent = 'Envoi des donnÃ©es...';
                statusMessage.style.color = '#8a2be2'; // Violet pour l'Ã©tat d'envoi

                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    if (key.endsWith('[]')) {
                        const cleanKey = key.slice(0, -2);
                        if (!data[cleanKey]) {
                            data[cleanKey] = [];
                        }
                        data[cleanKey].push(value);
                    } else {
                        data[key] = value;
                    }
                });

                data.Horodateur = new Date().toLocaleString('fr-FR', { timeZone: 'Europe/Paris' });

                try {
                    const submitterName = data.ViaNom || 'cher contributeur/chÃ¨re contributrice';

                    const response = await fetch(googleAppsScriptWebAppUrl, {
                        method: 'POST',
                        mode: 'no-cors', // MAINTENIR 'no-cors' car setHeader ne fonctionne pas cÃ´tÃ© Apps Script
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });

                    // Avec 'no-cors', nous ne pouvons PAS lire la rÃ©ponse du serveur (response.json() Ã©chouerait).
                    // Nous devons ASSUMER le succÃ¨s si la requÃªte fetch ne tombe pas en erreur rÃ©seau.
                    // Le statut 'opaque' signifie que la requÃªte a Ã©tÃ© envoyÃ©e mais que la rÃ©ponse est inaccessible.
                    if (response.type === 'opaque' || response.ok) { // response.ok ne sera vrai qu'en mode 'cors'
                        statusMessage.textContent = 'Votre Ã©vÃ©nement a Ã©tÃ© envoyÃ© avec succÃ¨s ! Merci !';
                        statusMessage.style.color = '#67c23a';

                        form.reset();
                        localStorage.removeItem(localStorageKey);
                        eventAddressInput.value = '';
                        eventCityInput.value = '';
                        form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                        form.querySelectorAll('.error-message').forEach(el => el.remove());

                        confirmationNameSpan.textContent = submitterName;
                        showSection('confirmation-section');
                    } else {
                        // Ce bloc ne sera probablement pas atteint en mode 'no-cors' pour les erreurs rÃ©seau simples
                        // Mais il est bon de le laisser pour d'autres types de problÃ¨mes de fetch
                        statusMessage.textContent = 'Erreur lors de l\'envoi du formulaire. Veuillez rÃ©essayer.';
                        statusMessage.style.color = '#f56c6c';
                        console.error('RÃ©ponse non opaque ou non ok:', response);
                    }

                } catch (error) {
                    console.error("Erreur lors de l'envoi Ã  Google Sheets :", error);
                    // Ce bloc catch gÃ¨re les erreurs rÃ©seau (ex: pas de connexion, URL incorrecte)
                    statusMessage.textContent = 'Erreur rÃ©seau lors de l\'envoi du formulaire. VÃ©rifiez votre connexion.';
                    statusMessage.style.color = '#f56c6c';
                }
            });

            // --- Initialisation et gestion des clics sur les boutons de navigation ---
            startFormButton.addEventListener('click', () => {
                showSection('form-section');
                loadFormFromLocalStorage(); // Load data when form is shown
            });

            // Au chargement initial, s'assurer que seule la section d'introduction est visible
            showSection('intro-section');
        });
    </script>
</body>
</html>
